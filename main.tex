\documentclass[12pt, letterpaper]{book}

\def\theauthor{Kelvin Chan}
\def\theinstitute{University of Western Ontario}
\def\thecourseterm{Fall/Winter}
\def\thecourseyear{2024}
\def\thecoursesubj{Calc}
\def\thecoursesubject{Calculus}
\def\thecoursenumb{1000}
\def\thecoursesect{}
\def\thecoursename{Calculus I}
\def\thecoursetitle{\thecoursesubj~\thecoursenumb: \thecoursename}
\def\thecoursecoordinator{}
\def\thecourseinstructor{\theauthor}
\def\thecourselms{BrightSpace}

\def\thecoursetextbooktitle{Calculus, Volume 1}
\def\thecoursetextbookurl{\url{https://openstax.org/details/books/calculus-volume-1}}
\def\thecoursetextbookpublisher{OpenStax}
\def\thecoursetextbook{\href{https://openstax.org/details/books/calculus-volume-1}{\thecoursetextbooktitle}}

% ------------------------------------------------------------
%
%             TITLE
%
% ------------------------------------------------------------
\title{\thecoursetitle}
\author{\theauthor}
\date{\today}


% ------------------------------------------------------------
%
%             PAGE SETUP
%
% ------------------------------------------------------------
\usepackage[margin=0.75in, top=0.25in, bottom=0.25in, nofoot, nomarginpar, includehead, includefoot, headheight=15pt, footskip=5pt]{geometry}

% header and footers
\usepackage{fancyhdr} % must be loaded after geometry

% base style for all pages
\fancypagestyle{base}{
  \fancyhf{}
  \fancyhead[OR, EL]{\small Page~\thepage}
  \renewcommand{\headrulewidth}{0pt}
}
\pagestyle{base}

\fancypagestyle{draft}[base]{
  \fancyhead[OL, ER]{\small \hlwarn{Draft}}
  \renewcommand{\headrulewidth}{.4pt}
}

% base style for the first page of a chapter
\newcommand{\firstpageheader}{}
\fancypagestyle{firstpage}[base]{
  \fancyhead[OL, ER]{\small \thecoursesubj{}~\thecoursenumb~\thecoursesect}
  \fancyhead[C]{\small\firstpageheader{}}
  \renewcommand{\headrulewidth}{.4pt}
}

% for syllabus
\fancypagestyle{syllabus}[firstpage]{
  \fancyhead[C]{\small Syllabus}
}

% ------------------------------------------------------------
%
%           PACKAGES
%
% ------------------------------------------------------------
% colours
\input{./colours.tex.preamble}

% math
\usepackage{amsmath, amsthm, amssymb, amsfonts}
\usepackage{cancel}
\everymath{\displaystyle}

% typography
\usepackage{fontspec}
\usepackage{microtype} 
\usepackage{parskip}
\usepackage{ragged2e}
\usepackage[normalem]{ulem}

% embedded markups
\usepackage{markdown}

% subfiles
\usepackage{refcount, xr, subfiles}

% links and references
\PassOptionsToPackage{hyphens}{url}
\usepackage[hidelinks, pdfusetitle]{hyperref}
\renewcommand{\UrlFont}{\footnotesize\ttfamily}

% lists
\usepackage[inline]{enumitem}

% figures
\usepackage{float}

% plots
\input{./tikz.tex.preamble}

% tables
\usepackage{booktabs}

% framed callout boxes
\usepackage[framemethod=tikz]{mdframed}
\mdfdefinestyle{wide}{
  % userdefinedwidth=0.95\textwidth,
  innertopmargin=1em,
  innerleftmargin=1em,
  innerbottommargin=1em,
  innerrightmargin=1em,
  skipabove=1em,
  skipbelow=1em,
  align=center,
  roundcorner=3pt,
}
\mdfdefinestyle{simple}{
  userdefinedwidth=0.9\textwidth,
  innertopmargin=1em,
  innerleftmargin=1em,
  innerbottommargin=1em,
  innerrightmargin=1em,
  skipabove=1em,
  skipbelow=1em,
  align=center,
  roundcorner=3pt,
  startinnercode={\linespread{1.5}\selectfont}
}

\mdfdefinestyle{simple-compact}{
  userdefinedwidth=0.9\textwidth,
  innertopmargin=1em,
  innerleftmargin=1em,
  innerbottommargin=1em,
  innerrightmargin=1em,
  skipabove=1em,
  skipbelow=1em,
  align=center,
  roundcorner=3pt,
}

\mdfdefinestyle{sidenote}{
  userdefinedwidth=0.3\textwidth,
  innertopmargin=1em,
  innerleftmargin=1em,
  innerbottommargin=1em,
  innerrightmargin=1em,
  skipabove=1em,
  skipbelow=1em,
  align=right,
  topline=false,
  rightline=false,
  bottomline=false,
  startinnercode={\footnotesize}
}

\mdfdefinestyle{withref}{
  userdefinedwidth=0.9\textwidth,
  innertopmargin=1em,
  innerleftmargin=1em,
  innerbottommargin=0.25em,
  innerrightmargin=1em,
  skipabove=1em,
  skipbelow=1em,
  align=center,
  roundcorner=3pt,
  startinnercode={\linespread{1.5}\selectfont}
}

\mdfdefinestyle{withref-compact}{
  userdefinedwidth=0.9\textwidth,
  innertopmargin=1em,
  innerleftmargin=1em,
  innerbottommargin=0.25em,
  innerrightmargin=1em,
  skipabove=1em,
  skipbelow=1em,
  align=center,
  roundcorner=3pt,
}

% fonts
\usepackage[mathcal]{euscript}
\usepackage{fontawesome5}

% section titles
\usepackage[sc,center,tiny]{titlesec}
\titlelabel{\thetitle.\;}
% \titleformat{⟨command⟩}[⟨shape⟩]{⟨format⟩}{⟨label⟩}{⟨sep⟩}{⟨before-code⟩}[⟨after-code⟩]
\titleformat{\subsection}{\bfseries}{\thesubsection}{1ex}{}{}
\titleformat{\subsubsection}{}{\thesubsection}{1ex}{}{}


% ------------------------------------------------------------
%
%           Math
%
% ------------------------------------------------------------
\numberwithin{equation}{chapter}
\theoremstyle{definition}
\newtheorem{thm}{Theorem}
\newtheorem{example}[thm]{Example}

\newcommand{\textbook}[1]{\noindent{} {\footnotesize \faBookReader{} #1 \hfill}}
\newcommand{\stewart}[1]{#1}

% better looking symbols
\renewcommand{\epsilon}{\varepsilon}
\renewcommand{\emptyset}{\varnothing}
\renewcommand{\arctan}{\tan^{-1}}
\renewcommand{\arcsin}{\sin^{-1}}
\renewcommand{\arccos}{\cos^{-1}}


% ------------------------------------------------------------
%
%           Fill in the blanks
%
% ------------------------------------------------------------
\newcommand{\blanklines}[2][40]{
  \par{}
  \includegraphics{./standalones/build/grid_#2_by_40}
  \smallbreak
  % assume textarea is 7in wide.
  % need to scale ever so slightly to avoid overfull box warning
  % \par{}
  % \begin{tikzpicture}[x=.175in,y=.175in,scale=0.99]
  %   \foreach \x in {0,1,...,#1}
  %   {
  %     \foreach \y in {0,1,...,#2}
  %     {
  %       \fill[gray!40] (\x,\y) circle[radius=0.5pt];
  %     }
  %   }
  % \end{tikzpicture}
  % \smallskip{}
}

% ------------------------------------------------------------
%
%         Keep track of page numbering of the weeks
%
% ------------------------------------------------------------
\usepackage{luacode}
\directlua{weeks = {}}

% ------------------------------------------------------------
%
%           Make a week environment
%
% ------------------------------------------------------------
\newcounter{week}
\setcounter{week}{0}
\newenvironment{week}[1]{
  \refstepcounter{week}

  % befor code
  % chapter and section numbering
  \setcounter{chapter}{\theweek}
  \setcounter{section}{0}
  \setcounter{thm}{0}

  % add to TOC
  \phantomsection{}\label{week\theweek}
  % \addcontentsline{toc}{chapter}{Week~\theweek~(#1)}
  \addcontentsline{toc}{chapter}{Week~\theweek}

  % \renewcommand{\firstpageheader}{Week~\theweek~(#1)}
  \renewcommand{\firstpageheader}{Week~\theweek}
  \thispagestyle{firstpage}
}{
  \clearpage{\thispagestyle{empty}\cleardoublepage}
  \renewcommand{\firstpageheader}{}
  \directlua{weeks[\theweek] = \the\value{page}}
}

\begin{document}
% --------------------
% 
% TITLE PAGE
% 
% --------------------
\begin{titlepage}
  \thispagestyle{empty}
  \huge

  \begin{center}
    % title
    \phantom{top}
    \vspace{1in}

    {\Huge\bfseries \thecoursetitle}

    \vspace{1cm}
    \theauthor

    \theinstitute
    \vfill{}

    \thecourseterm~\thecourseyear

    \vspace{2in}
  \end{center}

  % creaate a blank page
  \clearpage{\thispagestyle{empty}\cleardoublepage}
\end{titlepage}
\directlua{titlepage = \the\value{page} - 1}  % has be the line immediaately after \end{titlepage}

% --------------------
% 
% FRONT MATTER
% 
% --------------------
\frontmatter{}
\pagenumbering{roman}

\renewcommand{\contentsname}{Table of Contents}
\phantomsection{} \label{toc}
\addcontentsline{toc}{chapter}{\contentsname}
\tableofcontents{}
\clearpage

\clearpage{\thispagestyle{empty}\cleardoublepage}
\directlua{frontmatter = \the\value{page} - 1}  % has to be the last line of the front matter

%--------------------
% 
% MAIN MATTER
% 
% --------------------
\mainmatter{}

\begin{week}{September 5 and 6}
  \subfile{./lessons/review-function-basics.tex} 
\end{week}

\begin{week}{September 9 to 13}
  \subfile{./lessons/review-trigs.tex} \clearpage
  \subfile{./lessons/review-piecewise.tex} \clearpage
  \subfile{./lessons/review-decomposition.tex} \clearpage
  \subfile{./lessons/review-inverses.tex} \clearpage
  \subfile{./lessons/review-exp.tex} \clearpage
\end{week}

\begin{week}{September 16 to 20}
  \subfile{./lessons/limit-introduction.tex} \clearpage
  \subfile{./lessons/limit-laws.tex} \clearpage
  \subfile{./lessons/continuity.tex} \clearpage
  \subfile{./lessons/continuity-ivt.tex} \clearpage
\end{week}

\begin{week}{September 23 to 27}
  \subfile{./lessons/limit-at-infinity.tex} \clearpage
  \subfile{./lessons/derivative-at-a-point.tex} \clearpage
  \subfile{./lessons/derivative-as-a-function.tex} \clearpage
\end{week}

\begin{week}{September 30 to October 4}
  \subfile{./lessons/derivative-continuity.tex} \clearpage
  \subfile{./lessons/differentiation-summary.tex} \clearpage
  \subfile{./lessons/differentiation-rules.tex} \clearpage
  \subfile{./lessons/differentiation-trigs.tex} \clearpage
  \subfile{./lessons/differentiation-problem-solving.tex} \clearpage
\end{week}

\begin{week}{October 7 to 11}
  \subfile{./lessons/differentiation-chain.tex} \clearpage
  \subfile{./lessons/differentiation-implicit.tex} \clearpage
  \subfile{./lessons/differentiation-inverse.tex} \clearpage
  \subfile{./lessons/differentiation-exp-ln.tex} \clearpage
\end{week}

\begin{week}{October 14 to 18}
  \subfile{./lessons/reading-week.tex} \clearpage
\end{week}

\begin{week}{October 21 to 25}
  \subfile{./lessons/differentiation-logarithmic-differentiation.tex} \clearpage
  \subfile{./lessons/differentiation-strategies.tex} \clearpage
  \subfile{./lessons/related-rates.tex} \clearpage
\end{week}

\begin{week}{October 28 to November 1}
  \subfile{./lessons/extrema.tex} \clearpage
  \subfile{./lessons/derivative-tests.tex} \clearpage
\end{week}

\begin{week}{November 4 to 8}
  \subfile{./lessons/optimization.tex} \clearpage
  \subfile{./lessons/extrema-subtleties.tex} \clearpage
  \subfile{./lessons/lHopitals-rule.tex} \clearpage
\end{week}

\begin{week}{November 11 to 15} % 4.10 and 5.1
  \subfile{./lessons/integration-intro.tex} \clearpage
  \subfile{./lessons/integration-formulas.tex} \clearpage
  \subfile{./lessons/sigma-notation.tex} \clearpage
  \subfile{./lessons/antiderivatives.tex} \clearpage
  \subfile{./lessons/the-area-problem.tex} \clearpage
\end{week}

\begin{week}{November 18 to 22} % 5.2 and 5.3
  \subfile{./lessons/the-definite-integral.tex} \clearpage
  \subfile{./lessons/ftc-part-one.tex} \clearpage
  \subfile{./lessons/ftc-part-two.tex} \clearpage
  \subfile{./lessons/net-change.tex} \clearpage
\end{week}

\begin{week}{November 25 to 29} % 5.4, 5.5, 5.6, 6.1 and 6.2
  \subfile{./lessons/integration-substitution.tex} \clearpage
  \subfile{./lessons/area-between-curves.tex} \clearpage
  \subfile{./lessons/volume-by-slicing.tex} \clearpage
\end{week}

\begin{week}{December 2 to 6} % review
  \subfile{./lessons/integration-strategy.tex} \clearpage
  \subfile{./lessons/exam-strategies.tex} \clearpage
\end{week}

%--------------------
% 
% BACK MATTER
% 
% --------------------
\backmatter{}

%--------------------
% 
% generate files in the publish direjctory
% 
% --------------------
\begin{luacode}
  local offset = titlepage + frontmatter
  local prev = offset + 1
  for i, pagenum in pairs(weeks) do
  local f = io.open(string.format("./publish/week%d.tex", i), "w")
  local a = prev
  local b = pagenum + offset - 1
  local s = string.format("\\includepdf[pages=%d-%d]{../build/main.pdf}", a, b)

  f:write("\\documentclass{article}")
  f:write("\\usepackage{pdfpages}")
  f:write("\\begin{document}")
  f:write(s)
  f:write("\\end{document}")
  f:close()

  prev = b + 1
  end
\end{luacode}
\end{document}
